#!/bin/bash
# Pre-commit hook para validar specs antes de commit
#
# Instalaci√≥n:
#   cp scripts/spec-validator/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# O con el comando:
#   bun run install:hooks

set -e

# Obtener archivos .md modificados en el commit
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' | grep '^specs/' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  # No hay archivos de specs modificados, salir OK
  exit 0
fi

echo "üîç Validando especificaciones modificadas..."
echo ""

# Crear archivo temporal con la lista de archivos
TEMP_FILE=$(mktemp)
echo "$STAGED_MD_FILES" > "$TEMP_FILE"

# Contador de errores
ERRORS=0

# Validar cada archivo modificado
while IFS= read -r file; do
  if [ -f "$file" ]; then
    echo "  Validando: $file"

    # Ejecutar validador solo en el archivo espec√≠fico
    if ! bun run validate:specs "$file" --level frontmatter > /dev/null 2>&1; then
      echo "    ‚ùå Error de frontmatter"
      ERRORS=$((ERRORS + 1))
    fi

    if ! bun run validate:specs "$file" --level structure > /dev/null 2>&1; then
      echo "    ‚ö†Ô∏è  Warning de estructura"
      # No incrementamos errores para warnings de estructura
    fi
  fi
done < "$TEMP_FILE"

rm "$TEMP_FILE"

echo ""

if [ $ERRORS -gt 0 ]; then
  echo "‚ùå Se encontraron $ERRORS errores en las especificaciones"
  echo ""
  echo "Ejecuta 'bun run validate:specs' para ver los detalles"
  echo "Usa 'git commit --no-verify' para saltar esta validaci√≥n (no recomendado)"
  exit 1
fi

echo "‚úÖ Todas las especificaciones pasaron la validaci√≥n"
exit 0
